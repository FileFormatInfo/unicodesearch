#!/usr/bin/env bash
#
# Download and unzip the Unicode Character Database XML file
# from Unicode.org.
#

set -o nounset
set -o errexit
set -o pipefail

SCRIPT_HOME="$( cd "$( dirname "$0" )" && pwd )"
BASE_DIR=$(realpath "${SCRIPT_HOME}/..")

SRC_DIR="${BASE_DIR}/src"
SRC_PATH="${SRC_DIR}/scriptMap.ts"

echo "INFO: starting map gen at $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

TMP_DIR="${BASE_DIR}/tmp"
if [ ! -d "${TMP_DIR}" ]; then
	echo "INFO: creating temp dir ${TMP_DIR}"
	mkdir -p "${TMP_DIR}"
else
	echo "INFO: using existing temp dir ${TMP_DIR}"
fi

if [ -f "${TMP_DIR}/PropertyValueAliases.txt" ]; then
	echo "INFO: using existing PropertyValueAliases.txt"
else
	curl \
		--location \
		--output "${TMP_DIR}/PropertyValueAliases.txt" \
		--show-error \
		--silent \
		https://www.unicode.org/Public/latest/ucd/PropertyValueAliases.txt
fi

cd "${TMP_DIR}"

echo "INFO: generating script map to ${SRC_PATH}"

echo "/* This file is generated by bin/make_script_map.sh */" > "${SRC_PATH}"
echo "export const scriptMap: { [key: string]: string } = {" >> "${SRC_PATH}"


grep "^sc ; " PropertyValueAliases.txt | \
	cut -d';' -f2,3 | \
	awk -F'; ' '{ gsub(/[ \t]+/, "", $1); gsub(/[ \t]+$/, "", $2); printf("\"%s\": \"%s\",\n", $1, $2); }' \
	>> "${SRC_PATH}"

echo "};" >> "${SRC_PATH}"

echo "INFO: completed map gen at $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
